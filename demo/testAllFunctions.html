<!DOCTYPE html>
<html>
<head>
    <title>tornado WebSocket example</title>
    <!--File auto-generated by the server.
    Path needs to match with Hub.constructJSFile path parameter-->
    <script type="text/javascript" src="_static/hubsApi.js"></script>
    <style>
        pre {
            outline: 1px solid #ccc;
            padding: 5px;
            margin: 5px;
        }

        .string {
            color: green;
        }

        .number {
            color: darkorange;
        }

        .boolean {
            color: blue;
        }

        .null {
            color: magenta;
        }

        .key {
            color: red;
        }

        #connectionStatus {
            margin-bottom: 4px;
        }

        .connected {
            color: #16dd16;
        }

        .disconnected {
            color: darkred;
        }

        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        td button {
            height: 100%;
            width: 100%;
            min-height: 25px;
        }

        tr:nth-child(even) {
            background: #fff7db
        }

        tr:nth-child(even) input {
            background: #e5ddc2
        }

        tr:nth-child(odd) {
            background: #FFF
        }

        li {
            font-size: larger;
            margin: 7px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="main" style="display: flex; flex-direction: column; height: 100vh">
    <div class="container">
        <h2>Test all hubs functions</h2>
        <h3 id="connectionStatus">Disconnected</h3>
    </div>
    <div id="tables" style="overflow: auto; flex:1"></div>
    <div id="result" style="height: 150px"></div>
</div>

<script>
    var hubsApi = new HubsAPI(15000),
        connectionStatusEle = document.getElementById("connectionStatus"),
        tablesDiv = document.getElementById("tables"),
        resultDiv = document.getElementById("result"),
        resultPreElement = document.createElement('pre');
    hubsApi.connect('ws://127.0.0.1:9876/', 2);
    hubsApi.onOpen = function () {
        connectionStatusEle.innerText = "Connected";
        connectionStatusEle.className = 'connected';
    };
    hubsApi.onClose = function (error) {
        connectionStatusEle.innerText = "Disconnected";
        connectionStatusEle.className = 'disconnected';
        console.error(error);
    };

    hubsApi.LoggingHub.client.onLoggingMessage = function () {
        console.log(arguments);
    };
    hubsApi.LoggingHub.server.subscribeToHub();

    var STRIP_COMMENTS = /(\/\/.*$)|(\/\*[\s\S]*?\*\/)|(\s*=[^,\)]*(('(?:\\'|[^'\r\n])*')|("(?:\\"|[^"\r\n])*"))|(\s*=[^,\)]*))/mg;
    var ARGUMENT_NAMES = /([^\s,]+)/g;
    function getParamNames(func) {
        var fnStr = func.toString().replace(STRIP_COMMENTS, '');
        var result = fnStr.slice(fnStr.indexOf('(') + 1, fnStr.indexOf(')')).match(ARGUMENT_NAMES);
        if (result === null)
            result = [];
        return result;
    }

    function syntaxHighlight(json) {
        json = JSON.stringify(arguments, null, 2)
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function output(inp, element) {
        inp = syntaxHighlight(inp);
        resultPreElement.innerHTML = inp;
    }

    var hubsInfo = {};
    for (hubName in hubsApi) {
        if (hubsApi.hasOwnProperty(hubName) && hubsApi[hubName] && hubsApi[hubName].server && hubsApi[hubName].server.__HUB_NAME) {
            var hubServer = hubsApi[hubName].server;
            hubsInfo[hubServer.__HUB_NAME] = {};
            for (fun in hubServer) {
                if (hubServer.hasOwnProperty(fun) && typeof hubServer[fun] === 'function') {
                    hubsInfo[hubServer.__HUB_NAME][fun] = {args: getParamNames(hubServer[fun])}
                }
            }
        }
    }


    for (var hubName in hubsInfo) {
        if (hubsInfo.hasOwnProperty(hubName)) {
            var title = document.createElement("li");
            var table = document.createElement("TABLE");
            var showButton = document.createElement("button");
            var titleBr = document.createElement("br");
            table.style.display = 'none';

            tablesDiv.appendChild(title);
            title.innerHTML = hubName;
            tablesDiv.appendChild(showButton);
            showButton.innerHTML = "Show";
            showButton.table = table;
            showButton.onclick = function () {
                if (this.table.style.display === '') {
                    this.table.style.display = 'none';
                    this.innerHTML = "Show";
                } else {
                    this.table.style.display = '';
                    this.innerHTML = "Hide";
                }
            };
            tablesDiv.appendChild(titleBr);
            tablesDiv.appendChild(table);
            var header = table.createTHead();
            var row = header.insertRow(-1);
            row.insertCell(-1).innerHTML = "<b>Function name</b>";
            row.insertCell(-1).innerHTML = "<b>Args</b>";
            row.insertCell(-1).innerHTML = "<b>Args values</b>";
            row.insertCell(-1).innerHTML = "<b>Send</b>";
            for (var functionName in hubsInfo[hubName]) {
                var args = hubsInfo[hubName][functionName].args;
                var newRow = table.insertRow(-1);
                newRow.insertCell(-1).innerHTML = functionName;
                newRow.insertCell(-1).innerHTML = hubsInfo[hubName][functionName].args.join("<br>");
                var argsCell = newRow.insertCell(-1);
                var sendButtonCell = newRow.insertCell(-1);
                var sendButton = document.createElement("button");
                sendButton.innerHTML = "Send";
                sendButtonCell.appendChild(sendButton);

                var argsInputs = [];
                for (var i = 0; i < args.length; i++) {
                    var input = document.createElement("input"),
                        br = document.createElement("br");
                    argsCell.appendChild(input);
                    argsCell.appendChild(br);
                    argsInputs.push(input);
                }
                sendButton.argsInputs = argsInputs;
                sendButton.functionName = functionName;
                sendButton.hubName = hubName;
                sendButton.onclick = function () {
                    var args = this.argsInputs.map(function (input) {
                        return input.value;
                    });
                    var f = hubsApi[this.hubName].server[this.functionName];
                    f.apply(f, args).then(
                        function () {
                            output({Sucess: true, args: arguments});
                            console.log({Sucess: true, args: arguments})
                        }, function () {
                            output({Sucess: false, args: arguments});
                            console.error(arguments)
                        }
                    )
                };
            }
        }
    }


    resultDiv.appendChild(resultPreElement)
</script>
</body>
</html>
